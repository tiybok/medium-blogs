<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Automate Kubernetes Cluster Using Ansible</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Automate Kubernetes Cluster Using Ansible</h1>
</header>
<section data-field="subtitle" class="p-summary">
Automate Kubernetes Cluster Using Ansible
</section>
<section data-field="body" class="e-content">
<section name="4b6c" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1b5e" id="1b5e" class="graf graf--h3 graf--leading graf--title">Automate Kubernetes Cluster Using Ansible</h3><p name="fa4a" id="fa4a" class="graf graf--p graf-after--h3">Automate Kubernetes Cluster Using Ansible</p><figure name="00c2" id="00c2" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*dHVh07_eUaBfHXUZUTA2-g.png" data-width="1516" data-height="664" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*dHVh07_eUaBfHXUZUTA2-g.png"></figure><p name="1547" id="1547" class="graf graf--p graf-after--figure">In this article I am going to show you how to install Wordpress with MySQL Database inside Multi Node Kubernetes k8s cluster on AWS using Ansible.</p><p name="bd58" id="bd58" class="graf graf--p graf-after--p">Task Description:- Automate Kubernetes Cluster Using Ansible</p><ul class="postList"><li name="1198" id="1198" class="graf graf--li graf-after--p">Launch ec2-instances on AWS Cloud eg. for master and slave.</li><li name="8344" id="8344" class="graf graf--li graf-after--li">Create roles that will configure master node and slave node seperately.</li><li name="a887" id="a887" class="graf graf--li graf-after--li">Launch a wordpress and mysql database connected to it in the respectine slaves.</li><li name="f4f0" id="f4f0" class="graf graf--li graf-after--li">Expose the WordPress pod and client able hit the wordpress ip with its respective port.</li></ul><p name="6098" id="6098" class="graf graf--p graf-after--li">Before start the practical demonstration let’s first know brief about all the technologies which going to use to solve the above use-case</p><h3 name="a539" id="a539" class="graf graf--h3 graf-after--p">Kubernetes</h3><p name="f33d" id="f33d" class="graf graf--p graf-after--h3">Kubernetes is a portable, extensible, open-source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.</p><p name="24c6" id="24c6" class="graf graf--p graf-after--p">The name Kubernetes originates from Greek, meaning helmsman or pilot. Google open-sourced the Kubernetes project in 2014. Kubernetes combines over 15 years of Google’s experience running production workloads at scale with best-of-breed ideas and practices from the community.</p><h4 name="8c26" id="8c26" class="graf graf--h4 graf-after--p">Why you need Kubernetes and What it can do</h4><p name="5193" id="5193" class="graf graf--p graf-after--h4">Containers are a good way to bundle and run your applications. In a production environment, you need to manage the containers that run the applications and ensure that there is no downtime. For example, if a container goes down, another container needs to start. Wouldn’t it be easier if this behavior was handled by a system?</p><p name="894b" id="894b" class="graf graf--p graf-after--p">That’s how Kubernetes comes to the rescue! Kubernetes provides you with a framework to run distributed systems resiliently. It takes care of scaling and failover for your application, provides deployment patterns, and more. For example, Kubernetes can easily manage a canary deployment for your system.</p><div name="72cf" id="72cf" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://tiybok45.medium.com/kubernetes-building-deploying-and-scaling-modern-applications-in-the-cloud-aa809168e6e2" data-href="https://tiybok45.medium.com/kubernetes-building-deploying-and-scaling-modern-applications-in-the-cloud-aa809168e6e2" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://tiybok45.medium.com/kubernetes-building-deploying-and-scaling-modern-applications-in-the-cloud-aa809168e6e2"><strong class="markup--strong markup--mixtapeEmbed-strong">Kubernetes : Building, Deploying and Scaling Modern Applications in the Cloud</strong><br><em class="markup--em markup--mixtapeEmbed-em">Industry Used Case on Kubernetes : CERN[European Council for Nuclear Research]</em>tiybok45.medium.com</a><a href="https://tiybok45.medium.com/kubernetes-building-deploying-and-scaling-modern-applications-in-the-cloud-aa809168e6e2" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="951ea90cf06b37a398dc540b0b30900e" data-thumbnail-img-id="1*toj5jm9x7yRELcktBhnr9g.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*toj5jm9x7yRELcktBhnr9g.png);"></a></div><h3 name="081a" id="081a" class="graf graf--h3 graf-after--mixtapeEmbed">Ansible</h3><p name="9ad6" id="9ad6" class="graf graf--p graf-after--h3">Ansible is a software tool that provides simple but powerful automation for cross-platform computer support. It is primarily intended for IT professionals, who use it for application deployment, updates on workstations and servers, cloud provisioning, configuration management, intra-service orchestration, and nearly anything a systems administrator does on a weekly or daily basis. Ansible doesn’t depend on agent software and has no additional security infrastructure, so it’s easy to deploy</p><h4 name="1ca4" id="1ca4" class="graf graf--h4 graf-after--p">How Ansible works</h4><p name="cb86" id="cb86" class="graf graf--p graf-after--h4">In Ansible, there are two categories of computers: the <em class="markup--em markup--p-em">control node</em> and <em class="markup--em markup--p-em">managed nodes</em>. The control node is a computer that runs Ansible. There must be at least one control node, although a backup control node may also exist. A managed node is any device being managed by the control node.</p><p name="6f10" id="6f10" class="graf graf--p graf-after--p">Ansible works by connecting to nodes (clients, servers, or whatever you’re configuring) on a network, and then sending a small program called an Ansible <em class="markup--em markup--p-em">module</em> to that node. Ansible executes these modules over SSH and removes them when finished. The only requirement for this interaction is that your Ansible control node has login access to the managed nodes. SSH keys are the most common way to provide access, but other forms of authentication are also supported.</p><div name="28fc" id="28fc" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://tiybok45.medium.com/how-industries-are-solving-challenges-using-ansible-69c835962825" data-href="https://tiybok45.medium.com/how-industries-are-solving-challenges-using-ansible-69c835962825" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://tiybok45.medium.com/how-industries-are-solving-challenges-using-ansible-69c835962825"><strong class="markup--strong markup--mixtapeEmbed-strong"><em class="markup--em markup--mixtapeEmbed-em">How Industries Are Solving Challenges Using Ansible</em></strong><br>How Industries Are Solving Challenges Using Ansibletiybok45.medium.com</a><a href="https://tiybok45.medium.com/how-industries-are-solving-challenges-using-ansible-69c835962825" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="33f823e0451676f12630fca313c9d78f" data-thumbnail-img-id="1*QqN1OVK64OeM9uUf7SkSNg.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*QqN1OVK64OeM9uUf7SkSNg.png);"></a></div><h3 name="8b6b" id="8b6b" class="graf graf--h3 graf-after--mixtapeEmbed">WordPress</h3><p name="6778" id="6778" class="graf graf--p graf-after--h3">At its core, <strong class="markup--strong markup--p-strong">WordPress is the simplest, most popular way to create your own website or blog. </strong>In fact, WordPress powers over 40% of all the websites on the Internet. Yes more than one in four websites that you visit are likely powered by WordPress.</p><p name="b9ef" id="b9ef" class="graf graf--p graf-after--p">On a slightly more technical level, WordPress is an open-source content management system licensed under GPLv2, which means that anyone can use or modify the WordPress software for free. A content management system is basically a tool that makes it easy to manage important aspects of your website like content without needing to know anything about programming.</p><p name="dd1c" id="dd1c" class="graf graf--p graf-after--p">The end result is that WordPress makes building a website accessible to anyone even people who aren’t developers.</p><h3 name="c989" id="c989" class="graf graf--h3 graf-after--p">MySQL</h3><p name="35da" id="35da" class="graf graf--p graf-after--h3">MySQL is the most popular Open Source Relational SQL Database Management System. MySQL is one of the best RDBMS being used for developing various web-based software applications</p><p name="91af" id="91af" class="graf graf--p graf-after--p">MySQL is used by many database<strong class="markup--strong markup--p-strong">-</strong>driven web applications, including Drupal, Joomla, phpBB, and WordPress.</p><p name="b8da" id="b8da" class="graf graf--p graf-after--p">If you are new to AWS , Do check go through this blog for better understanding</p><div name="8930" id="8930" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://tiybok45.medium.com/deploy-wordpress-application-on-ec2-instance-with-amazon-rds-e93b537ffd55" data-href="https://tiybok45.medium.com/deploy-wordpress-application-on-ec2-instance-with-amazon-rds-e93b537ffd55" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://tiybok45.medium.com/deploy-wordpress-application-on-ec2-instance-with-amazon-rds-e93b537ffd55"><strong class="markup--strong markup--mixtapeEmbed-strong">Deploy WordPress Application on EC2 Instance with Amazon RDS</strong><br><em class="markup--em markup--mixtapeEmbed-em">Deploy a WordPress Application on an EC2 instance by providing AWS RDS storage.</em>tiybok45.medium.com</a><a href="https://tiybok45.medium.com/deploy-wordpress-application-on-ec2-instance-with-amazon-rds-e93b537ffd55" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="9937d8aa813fc58eaa2bc33e25af898d" data-thumbnail-img-id="1*VWFiwRNw3QXF2tmKEnWnVg.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*VWFiwRNw3QXF2tmKEnWnVg.png);"></a></div><h4 name="3fe7" id="3fe7" class="graf graf--h4 graf-after--mixtapeEmbed">Pre-requisites</h4><p name="fe37" id="fe37" class="graf graf--p graf-after--h4">Do you need any kind of knowledge before going through this article? Yes, you do. You should have a basic knowledge of :</p><ul class="postList"><li name="92f0" id="92f0" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">The AWS public cloud</strong></li><li name="2f27" id="2f27" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Ansible playbook and roles</strong></li><li name="395d" id="395d" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Kubernetes</strong></li></ul><h3 name="7019" id="7019" class="graf graf--h3 graf-after--li">Ansible Installation and Configuration</h3><p name="5ac5" id="5ac5" class="graf graf--p graf-after--h3">Install Ansible on Base OS (RHEL8), configure ansible configuration file. <br>To do this use below commands-</p><pre name="83ce" id="83ce" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">yum install python3 -y<br><br>pip3 install ansible -y<br><br>vim /etc/ansible/ansible.cfg</code></pre><p name="38f1" id="38f1" class="graf graf--p graf-after--pre">Write below commands in your configuration ansible.cfg file.</p><pre name="9e90" id="9e90" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">[defaults]<br>inventory=/root/ip.txt                              #inventory path<br>host_key_checking=False<br>command_warnings=False<br>deprecation_warnings=False<br>ask_pass=False<br>roles_path= /root/roles                              #roles path<br>force_valid_group_names = ignore<br>private_key_file= /root/arthkey.pem                  #your key-pair <br>remote_user=ec2-user<br><br>[privilege_escalation]<br>become=True<br>become_method=sudo<br>become_user=root<br>become_ask_pass=False</code></pre><h3 name="776f" id="776f" class="graf graf--h3 graf-after--pre">Create Ansible Roles</h3><p name="f923" id="f923" class="graf graf--p graf-after--h3">Go inside your roles workspace</p><pre name="8663" id="8663" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd /roles</code></pre><p name="5d40" id="5d40" class="graf graf--p graf-after--pre">Use Below commands to create 3 different roles</p><ol class="postList"><li name="4116" id="4116" class="graf graf--li graf-after--p">For Kubernetes Cluster</li><li name="290f" id="290f" class="graf graf--li graf-after--li">For Kubernetes Master</li><li name="c390" id="c390" class="graf graf--li graf-after--li">For Kubernetes Slaves</li></ol><pre name="ae56" id="ae56" class="graf graf--pre graf-after--li"><code class="markup--code markup--pre-code"># ansible-galaxy init &lt;role_name&gt;<br><br>ansible-galaxy init kube_cluster<br>ansible-galaxy init k8s_master<br>ansible-galaxy init k8s_slave<br>ansible-galaxy init wordpress_mysql</code></pre><h3 name="8fa8" id="8fa8" class="graf graf--h3 graf-after--pre">Write role for Kubernetes Cluster</h3><p name="76b6" id="76b6" class="graf graf--p graf-after--h3">Go inside the tasks folder. We have to write entire tasks inside this folder</p><pre name="8166" id="8166" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd /roles/kube_cluster/tasks</code></pre><pre name="c898" id="c898" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim main.yml</code></pre><p name="9057" id="9057" class="graf graf--p graf-after--pre">I am going to create cluster over Amazon Linux instances.<br>Write below source code inside it-</p><pre name="c376" id="c376" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">- name: Installing boto &amp; boto3 libraries<br>  pip:<br>    name: &quot;{{ item }}&quot;<br>    state: present<br>  loop: &quot;{{ lib_names }}&quot;<br><br>- name: Creating Security Group for K8s Cluster<br>  ec2_group:<br>    name: &quot;{{ sg_name }}&quot;<br>    description: Security Group for allowing all port<br>    region: &quot;{{ region_name }}&quot;<br>    aws_access_key: &quot;{{ access_key }}&quot;<br>    aws_secret_key: &quot;{{ secret_key }}&quot;<br>    rules:<br>    - proto: all<br>      cidr_ip: 0.0.0.0/0<br>    rules_egress:<br>    - proto: all<br>      cidr_ip: 0.0.0.0/0<br><br>- name: Launching three EC2 instances on AWS<br>  ec2:<br>    key_name: &quot;{{ keypair }}&quot;<br>    instance_type: &quot;{{ instance_flavour }}&quot;<br>    image: &quot;{{ ami_id }}&quot;<br>    wait: true<br>    group: &quot;{{ sg_name }}&quot;<br>    count: 1<br>    vpc_subnet_id: &quot;{{ subnet_name }}&quot;<br>    assign_public_ip: yes<br>    region: &quot;{{ region_name }}&quot;<br>    state: present<br>    aws_access_key: &quot;{{ access_key }}&quot;<br>    aws_secret_key: &quot;{{ secret_key }}&quot;<br>    instance_tags:<br>      Name: &quot;{{ item }}&quot;<br>  register: ec2<br>  loop: &quot;{{ instance_tag }}&quot;<br><br>- name: Add 1st instance to host group ec2_master<br>    add_host:<br>    hostname: &quot;{{ ec2.results[0].instances[0].public_ip }}&quot;<br>    groupname: ec2_master<br><br>- name: Add 2nd instance to host group ec2_slave<br>  add_host:<br>    hostname: &quot;{{ ec2.results[1].instances[0].public_ip }}&quot;<br>    groupname: ec2_slave<br><br>- name: Add 3rd instance to host group ec2_slave<br>  add_host:<br>    hostname: &quot;{{ ec2.results[2].instances[0].public_ip }}&quot;<br>    groupname: ec2_slave<br><br>- name: Waiting for SSH<br>  wait_for:<br>    host: &quot;{{ ec2.results[2].instances[0].public_dns_name }}&quot;<br>    port: 22<br>    state: started</code></pre><h4 name="bd41" id="bd41" class="graf graf--h4 graf-after--pre">Go inside the vars folder. We have to write entire variables inside this folder.</h4><p name="e1a9" id="e1a9" class="graf graf--p graf-after--h4">We can directly mention variables inside tasks file but it is good practice to write them inside vars files so that we can change according to our requirements.</p><pre name="aad9" id="aad9" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd /roles/kube_cluster/vars</code></pre><pre name="119d" id="119d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim main.yml</code></pre><p name="6c55" id="6c55" class="graf graf--p graf-after--pre">Write below source code inside it-</p><pre name="435b" id="435b" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">instance_tag:<br>        - master<br>        - slave1<br>        - slave2</code></pre><pre name="d723" id="d723" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">lib_names:<br>        - boto<br>        - boto3</code></pre><pre name="8382" id="8382" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">sg_name: Allow_All_SG<br>region_name: ap-south-1<br>subnet_name: subnet-49f0e521<br>ami_id: ami-010aff33ed5991201<br>keypair: awskey<br>instance_flavour: t2.small</code></pre><h3 name="297a" id="297a" class="graf graf--h3 graf-after--pre">Write role for Kubernetes Master</h3><p name="0179" id="0179" class="graf graf--p graf-after--h3">Following are the steps which have to include in role for configuring the k8s master-</p><ol class="postList"><li name="60ab" id="60ab" class="graf graf--li graf-after--p">Installing docker and iproute-tc</li><li name="f10c" id="f10c" class="graf graf--li graf-after--li">Configuring the Yum repo for Kubernetes</li><li name="61cc" id="61cc" class="graf graf--li graf-after--li">Installing kubeadm, kubelet &amp; kubectl program</li><li name="e5aa" id="e5aa" class="graf graf--li graf-after--li">Enabling the docker and Kubernetes</li><li name="3749" id="3749" class="graf graf--li graf-after--li">Pulling the config images</li><li name="10af" id="10af" class="graf graf--li graf-after--li">Configuring the docker daemon.json file</li><li name="e7e5" id="e7e5" class="graf graf--li graf-after--li">Restarting the docker service</li><li name="5add" id="5add" class="graf graf--li graf-after--li">Configuring the Ip tables and refreshing sysctl</li><li name="e3d0" id="e3d0" class="graf graf--li graf-after--li">Starting kubeadm service</li><li name="9213" id="9213" class="graf graf--li graf-after--li">Setting HOME directory for .kube Directory</li><li name="b4ae" id="b4ae" class="graf graf--li graf-after--li">Copying file config file</li><li name="c8ee" id="c8ee" class="graf graf--li graf-after--li">Installing Addons e.g flannel</li><li name="8f5c" id="8f5c" class="graf graf--li graf-after--li">Creating the token</li><li name="176e" id="176e" class="graf graf--li graf-after--li">Store output of token in a file.</li></ol><p name="03b3" id="03b3" class="graf graf--p graf-after--li">Go inside the tasks folder. We have to write entire tasks inside this folder</p><pre name="a8b0" id="a8b0" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd /roles/k8s_master/tasks</code></pre><pre name="5378" id="5378" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim main.yml</code></pre><p name="8c86" id="8c86" class="graf graf--p graf-after--pre">Write below source code inside it-</p><pre name="20ad" id="20ad" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">- name: &quot;Installing docker and iproute-tc&quot;<br>  package:<br>     name:<br>         - docker<br>         - iproute-tc<br>     state: present</code></pre><pre name="1760" id="1760" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Configuring the Yum repo for kubernetes&quot;<br>  yum_repository:<br>     name: kubernetes<br>     description: Yum for k8s<br>     baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64<br>     enabled: yes<br>     gpgcheck: yes<br>     repo_gpgcheck: yes<br>     gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</code></pre><pre name="fca4" id="fca4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Installing kubeadm,kubelet kubectl program&quot;<br>  yum:<br>     name:<br>        - kubelet<br>        - kubectl<br>        - kubeadm<br>     state: present</code></pre><pre name="c317" id="c317" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Enabling the docker and kubenetes&quot;<br>  service:<br>     name: &quot;{{ item }}&quot;<br>     state: started<br>     enabled: yes<br>  loop:<br>        - kubelet<br>        - docker</code></pre><pre name="71fc" id="71fc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Pulling the config images&quot;<br>  shell: kubeadm config images pull</code></pre><pre name="3331" id="3331" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Confuring the docker daemon.json file&quot;<br>  copy:<br>    dest: /etc/docker/daemon.json<br>    content: |<br>      {<br>      &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]<br>      }</code></pre><pre name="30f3" id="30f3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Restarting the docker service&quot;<br>  service:<br>     name: docker<br>     state: restarted</code></pre><pre name="cda4" id="cda4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Configuring the Ip tables and refreshing sysctl&quot;<br>  copy:<br>    dest: /etc/docker/daemon.json<br>    content: |<br>      {<br>      &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]<br>      }</code></pre><pre name="999b" id="999b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;systemctl&quot;<br>  shell: &quot;sysctl --system&quot;</code></pre><pre name="be40" id="be40" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Starting kubeadm service&quot;<br>  shell: &quot;kubeadm init  --ignore-preflight-errors=all&quot;</code></pre><pre name="992c" id="992c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Creating .kube Directory&quot;<br>  file:<br>     path: $HOME/.kube<br>     state: directory</code></pre><pre name="de52" id="de52" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Copying file config file&quot;<br>  shell: &quot;cp -i /etc/kubernetes/admin.conf $HOME/.kube/config&quot;<br>  ignore_errors: yes</code></pre><pre name="6968" id="6968" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Installing Addons e.g flannel&quot;<br>  shell: &quot;kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&quot;</code></pre><pre name="991a" id="991a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Creating the token&quot;<br>  shell: &quot;kubeadm token create --print-join-command&quot;<br>  register: token</code></pre><pre name="f30f" id="f30f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- debug:<br>       msg: &quot;{{ token.stdout }}&quot;</code></pre><h3 name="09a7" id="09a7" class="graf graf--h3 graf-after--pre">Write role for Kubernetes Slaves</h3><p name="46a0" id="46a0" class="graf graf--p graf-after--h3">Following are the steps which have to include in role for configuring the k8s slaves-</p><ol class="postList"><li name="e2cd" id="e2cd" class="graf graf--li graf-after--p">Installing docker and iproute-tc</li><li name="c205" id="c205" class="graf graf--li graf-after--li">Configuring the Yum repo for Kubernetes</li><li name="0cc9" id="0cc9" class="graf graf--li graf-after--li">Installing kubeadm,kubelet kubectl program</li><li name="006f" id="006f" class="graf graf--li graf-after--li">Enabling the docker and Kubernetes</li><li name="139b" id="139b" class="graf graf--li graf-after--li">Pulling the config images</li><li name="c4d6" id="c4d6" class="graf graf--li graf-after--li">Configuring the docker daemon.json file</li><li name="b018" id="b018" class="graf graf--li graf-after--li">Restarting the docker service</li><li name="b34a" id="b34a" class="graf graf--li graf-after--li">Configuring the IP tables and refreshing sysctl</li><li name="456a" id="456a" class="graf graf--li graf-after--li">Copy the join command which we store while configuring master</li></ol><p name="24f0" id="24f0" class="graf graf--p graf-after--li">Go inside the tasks folder. We have to write entire tasks inside this folder</p><pre name="3ed0" id="3ed0" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd /roles/k8s_slave/tasks</code></pre><pre name="aaa4" id="aaa4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim main.yml</code></pre><p name="be7b" id="be7b" class="graf graf--p graf-after--pre">Write below source code inside it-</p><pre name="90ee" id="90ee" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">- name: &quot;Installing docker and iproute-tc&quot;<br>  package:<br>     name:<br>         - docker<br>         - iproute-tc<br>     state: present</code></pre><pre name="2f8c" id="2f8c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Configuring the Yum repo for kubernetes&quot;<br>  yum_repository:<br>     name: kubernetes<br>     description: Yum for k8s<br>     baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch<br>     enabled: yes<br>     gpgcheck: yes<br>     repo_gpgcheck: yes<br>     gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</code></pre><pre name="7d7d" id="7d7d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Installing kubeadm,kubelet kubectl program&quot;<br>  yum:<br>     name:<br>        - kubelet<br>        - kubectl<br>        - kubeadm<br>     state: present</code></pre><pre name="6482" id="6482" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Enabling the docker and kubenetes&quot;<br>  service:<br>     name: &quot;{{ item }}&quot;<br>     state: started<br>     enabled: yes<br>  loop:<br>        - kubelet<br>        - docker</code></pre><pre name="cde3" id="cde3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Pulling the config images&quot;<br>  shell: kubeadm config images pull</code></pre><pre name="b17f" id="b17f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Confuring the docker daemon.json file&quot;<br>  copy:<br>    dest: /etc/docker/daemon.json<br>    content: |<br>      {<br>      &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]<br>      }</code></pre><pre name="11a8" id="11a8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Restarting the docker service&quot;<br>  service:<br>     name: docker<br>     state: restarted</code></pre><pre name="bbb3" id="bbb3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;Configuring the Ip tables and refreshing sysctl&quot;<br>  copy:<br>    dest: /etc/sysctl.d/k8s.conf<br>    content: |<br>      net.bridge.bridge-nf-call-ip6tables = 1<br>      net.bridge.bridge-nf-call-iptables = 1</code></pre><pre name="7d37" id="7d37" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: &quot;systemctl&quot;<br>  shell: &quot;sysctl --system&quot;</code></pre><pre name="f878" id="f878" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- name: joining to Master<br>  command: &quot;{{ hostvars[groups[&#39;ec2_master&#39;][0]][&#39;token&#39;][&#39;stdout&#39;] }}&quot;</code></pre><h3 name="e941" id="e941" class="graf graf--h3 graf-after--pre">Write role for Wordpress and MySQL Setup</h3><p name="7a5e" id="7a5e" class="graf graf--p graf-after--h3">Following are the steps which have to include in role for configuring the Wordpress-</p><p name="8edf" id="8edf" class="graf graf--p graf-after--p">Go inside the files folder of wordpress_mysql role. We have to write entire configuration files inside this folder.<br>We have to create 5 files here to create pods, setup of PVC and secrets&#39; file.</p><pre name="6291" id="6291" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd /roles/wordpress_mysql/files</code></pre><pre name="d216" id="d216" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim wordpress.yml</code></pre><pre name="8270" id="8270" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim pvc_wordpress.yml</code></pre><pre name="21d0" id="21d0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim mysql.yml</code></pre><pre name="53ce" id="53ce" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim pvc_mysql.yml</code></pre><pre name="1d85" id="1d85" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim secret.yml</code></pre><p name="321f" id="321f" class="graf graf--p graf-after--pre">Write Below source to configure Wordpress installation part inside wordpress.yml file</p><pre name="768f" id="768f" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: wordpress<br>  labels:<br>    app: wordpress<br>spec:<br>  ports:<br>    - port: 80<br>      nodePort: 30333<br>  selector:<br>    app: wordpress<br>    tier: frontend<br>  type: LoadBalancer<br>---<br>apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2<br>kind: Deployment<br>metadata:<br>  name: wordpress<br>  labels:<br>    app: wordpress<br>spec:<br>  selector:<br>    matchLabels:<br>      app: wordpress<br>      tier: frontend<br>  strategy:<br>    type: Recreate<br>  template:<br>    metadata:<br>      labels:<br>        app: wordpress<br>        tier: frontend<br>    spec:<br>      volumes:<br>      - name: wordpress-persistent-storage<br>        persistentVolumeClaim:<br>          claimName: wordpress-pv-claim<br>      containers:<br>      - image: wordpress:4.8-apache<br>        name: wordpress<br>        env:<br>        - name: WORDPRESS_DB_HOST<br>          value: wordpress-mysql<br>        - name: WORDPRESS_DB_PASSWORD<br>          valueFrom:<br>            secretKeyRef:<br>              name: mysqlsecret<br>              key: password<br>        ports:<br>        - containerPort: 80<br>          name: wordpress<br>        volumes:<br>        volumeMounts:<br>        - name: wordpress-persistent-storage<br>          mountPath: /var/www/html</code></pre><p name="07eb" id="07eb" class="graf graf--p graf-after--pre">Write Below source to setup PVC for Wordpress in pvc_wordpress.yml file.</p><pre name="5bdc" id="5bdc" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">apiVersion: v1<br>kind: PersistentVolumeClaim<br>metadata:<br>   name: wordpress-pv-claim<br>   labels:<br>        app: wordpress<br>        tier: frontend<br>spec:<br>   storageClassName: &quot;&quot;<br>   resources:<br>        requests:<br>             storage: 1Gi<br>   accessModes:<br>     - ReadWriteOnce<br>---</code></pre><pre name="5e31" id="5e31" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">apiVersion: v1<br>kind: PersistentVolume<br>metadata:<br>  name: wordpress-pv<br>spec:<br>  storageClassName: &quot;&quot;<br>  capacity:<br>     storage: 1Gi<br>  accessModes:<br>    - ReadWriteOnce<br>  hostPath:<br>    path: /wordpressdata</code></pre><p name="b78f" id="b78f" class="graf graf--p graf-after--pre">Write Below source to configure MYSQL installation part inside mysql.yml file</p><pre name="3a90" id="3a90" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: wordpress-mysql<br>  labels:<br>    app: wordpress<br>spec:<br>  ports:<br>    - port: 3306<br>  selector:<br>    app: wordpress<br>    tier: mysql<br>  clusterIP: None<br>---<br>apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2<br>kind: Deployment<br>metadata:<br>  name: wordpress-mysql<br>  labels:<br>    app: wordpress<br>spec:<br>  selector:<br>    matchLabels:<br>      app: wordpress<br>      tier: mysql<br>  strategy:<br>    type: Recreate<br>  template:<br>    metadata:<br>      labels:<br>        app: wordpress<br>        tier: mysql<br>    spec:<br>      volumes:<br>      - name: mysql-persistent-storage<br>        persistentVolumeClaim:<br>          claimName: mysql-pv-claim<br>      containers:<br>      - image: mysql:5.6<br>        name: mysql<br>        env:<br>        - name: MYSQL_ROOT_PASSWORD<br>          valueFrom:<br>            secretKeyRef:<br>              name: mysqlsecret<br>              key: password<br>        - name: MYSQL_USER<br>          value: udit<br>        - name: MYSQL_DATABASE<br>          value: task23db<br>        ports:<br>        - containerPort: 3306<br>          name: mysql<br>        volumeMounts:<br>        - name: mysql-persistent-storage<br>          mountPath: /var/lib/mysql</code></pre><p name="cab0" id="cab0" class="graf graf--p graf-after--pre">Write Below source to setup PVC for MySQL in pvc_mysql.yml file.</p><pre name="c589" id="c589" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">apiVersion: v1<br>kind: PersistentVolumeClaim<br>metadata:<br>   name: mysql-pv-claim<br>   labels:<br>        app: wordpress<br>        tier: mysql<br>spec:<br>   storageClassName: &quot;&quot;<br>   resources:<br>        requests:<br>             storage: 1Gi<br>   accessModes:<br>     - ReadWriteOnce<br>---</code></pre><pre name="bfcf" id="bfcf" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">apiVersion: v1<br>kind: PersistentVolume<br>metadata:<br>  name: msql-pv<br>spec:<br>  storageClassName: &quot;&quot;<br>  capacity:<br>     storage: 1Gi<br>  accessModes:<br>    - ReadWriteOnce<br>  hostPath:<br>    path: /mysqldata</code></pre><p name="cd08" id="cd08" class="graf graf--p graf-after--pre">Lastly, create a secrete file secret.yml which will contain the password of the MySQL database-</p><pre name="9a72" id="9a72" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">apiVersion: v1<br>kind: Secret<br>metadata:<br>  name: Rutvik<br>data:<br>   password: MySql@2021</code></pre><p name="671f" id="671f" class="graf graf--p graf-after--pre">Go inside the tasks folder. We have to write entire tasks inside this folder</p><pre name="057d" id="057d" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd /roles/wordpress_mysql/tasks</code></pre><pre name="5196" id="5196" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">vim main.yml</code></pre><p name="c86d" id="c86d" class="graf graf--p graf-after--pre">Write below source code inside it-</p><pre name="66b6" id="66b6" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">- name: Copying Wordpress and MySQL files to K8s Master Node<br>    copy:<br>        src: &quot;{{ item }}&quot;<br>        dest: /root/<br>    loop:<br>        - mysql.yml<br>        - pvc_mysql.yml<br>        - pvc_wordpress.yml<br>        - secret.yml<br>        - wordpress.yml</code></pre><pre name="af0d" id="af0d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">  - name: Creating directory over which MySQL container mounts the PersistentVolume at /var/lib/mysql.<br>    file:<br>        path: /mysqldata<br>        state: directory</code></pre><pre name="e54a" id="e54a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">  - name: Creating directory over which WordPress container mounts the PersistentVolume at /var/www/html.<br>    file:<br>        path: /wordpressdata<br>        state: directory<br><br></code></pre><pre name="9dd5" id="9dd5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">  - name: Configuration and Setup of Wordpress and MySQL<br>    shell: &quot;kubectl create -f /root/{{ item }}&quot;<br>    loop:<br>        - mysql.yml<br>        - pvc_mysql.yml<br>        - pvc_wordpress.yml<br>        - wordpress.yml</code></pre><h3 name="1e30" id="1e30" class="graf graf--h3 graf-after--pre">Write Ansible Vault Files</h3><p name="86d9" id="86d9" class="graf graf--p graf-after--h3">Go to your roles workspace<br>Run below command and create vault file</p><pre name="94bb" id="94bb" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code"># ansible-vault create &lt;filename&gt;.yml</code></pre><pre name="4cfc" id="4cfc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">ansible-vault create cred.yml</code></pre><p name="5cfa" id="5cfa" class="graf graf--p graf-after--pre">It will ask to provide one vault password &amp; provide as per your choice.<br>Then, open it with editor, create two variables in this file &amp; put your AWS <code class="markup--code markup--p-code">access key</code> &amp; <code class="markup--code markup--p-code">secret key</code> as values. <br>For example:</p><pre name="d059" id="d059" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">access_key: XXXXXXXXXXXXXXXXXXX<br>secret_key: XXXXXXXXXXXXXXXXXXX</code></pre><h3 name="b00b" id="b00b" class="graf graf--h3 graf-after--pre">Create Setup file</h3><p name="0862" id="0862" class="graf graf--p graf-after--h3">Now it’s finally the time to create the setup.yml file inside same workspace which we gonna run to setup this entire infrastructure on AWS.</p><pre name="5bbe" id="5bbe" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">- hosts: localhost<br>  gather_facts: no<br>  vars_files:<br>         - cred.yml<br>  tasks:<br>         - name: &quot;Running kube_cluster role&quot;<br>           include_role:<br>                name: kube_cluster<br><br></code></pre><pre name="fd53" id="fd53" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- hosts: ec2_master<br>  gather_facts: no<br>  tasks:<br>    - name: Running K8s_Master Role<br>      include_role:<br>        name: k8s_master</code></pre><pre name="a206" id="a206" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- hosts: ec2_slave<br>  gather_facts: no<br>  tasks:<br>    - name: Running K8s_Slave Role<br>      include_role:<br>        name: k8s_slave</code></pre><pre name="f1c7" id="f1c7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">- hosts: ec2_master<br>  gather_facts: no<br>  tasks:<br>    - name: Running Wordpress-MySQL Role<br>      include_role:<br>        name: wordpress_mysql</code></pre><h3 name="9318" id="9318" class="graf graf--h3 graf-after--pre">Run Ansible Playbook</h3><p name="6af9" id="6af9" class="graf graf--p graf-after--h3">Use below commands to run your ansible playbook.</p><pre name="146e" id="146e" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">ansible-playbook setup.yml --ask-vault-pass</code></pre><p name="e3b5" id="e3b5" class="graf graf--p graf-after--pre">Next it will prompt you to pass the password of your Ansible Vault (cred.yml file), provide your password.</p><figure name="ce18" id="ce18" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*pB2Ov57542tM0HvRMkIB9Q.png" data-width="1662" data-height="914" src="https://cdn-images-1.medium.com/max/800/1*pB2Ov57542tM0HvRMkIB9Q.png"></figure><figure name="33e1" id="33e1" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*YDlXI1TO8egGHqtLUaPy1Q.png" data-width="1663" data-height="756" src="https://cdn-images-1.medium.com/max/800/1*YDlXI1TO8egGHqtLUaPy1Q.png"></figure><p name="803d" id="803d" class="graf graf--p graf-after--figure">It run successfully and setup entire infrastructure</p><figure name="c003" id="c003" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*DJG74gxm1JwR66V58d-Ivw.png" data-width="1665" data-height="744" src="https://cdn-images-1.medium.com/max/800/1*DJG74gxm1JwR66V58d-Ivw.png"></figure><h3 name="ff97" id="ff97" class="graf graf--h3 graf-after--figure">Testing</h3><p name="2678" id="2678" class="graf graf--p graf-after--h3">Now lets check our multi-node cluster is using below commands</p><pre name="bbab" id="bbab" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">kubectl get nodes</code></pre><p name="2f47" id="2f47" class="graf graf--p graf-after--pre">Here we can see our who cluster is launched successfully and our all nodes is ready phase.</p><p name="7263" id="7263" class="graf graf--p graf-after--p">Now once your pods are ready, then you can take the public of any node either master or slave with the exposed port you will landed to the Wordpress login page and then enter password and username of the mysql database and hit the run installation button.</p><figure name="4440" id="4440" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*D7wa3P-maXhqxbXYowRwdw.png" data-width="1303" data-height="699" src="https://cdn-images-1.medium.com/max/800/1*D7wa3P-maXhqxbXYowRwdw.png"></figure><p name="de92" id="de92" class="graf graf--p graf-after--figure">Your Wordpress application is ready !</p><h3 name="d9a1" id="d9a1" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="888b" id="888b" class="graf graf--p graf-after--h3 graf--trailing">We successfully implemented our use case which is to launch the entire Kubernetes cluster on AWS cloud, just in one click. An extra part would be launching apps like WordPress and MySQL on the top of the cluster.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@tiybok45" class="p-author h-card">Rutvik Bhalerao</a> on <a href="https://medium.com/p/c57ee514426f"><time class="dt-published" datetime="2022-06-12T06:04:32.481Z">June 12, 2022</time></a>.</p><p><a href="https://medium.com/@tiybok45/automate-kubernetes-cluster-using-ansible-c57ee514426f" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 22, 2022.</p></footer></article></body></html>